# Azure DevOps Pipeline for drug-safety-mcp
# Uses self-hosted agent pool for builds

trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - '*.md'
      - '.vscode/**'

pool:
  name: 'Default'  # Self-hosted agent pool

variables:
  # Shared variables from Library (contains AZURE_KEYVAULT_NAME, etc.)
  - group: mcp-shared-vars
  - name: nodeVersion
    value: '20.x'

stages:
  # ============================================================================
  # BUILD & TEST
  # ============================================================================
  - stage: Build
    displayName: 'Build & Test'
    jobs:
      - job: BuildJob
        displayName: 'Build and Test'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js'

          - script: npm ci
            displayName: 'Install dependencies'

          - script: npm run build
            displayName: 'Build TypeScript'

          - script: npm run lint || true
            displayName: 'Lint code'
            continueOnError: true

          - script: npm test || true
            displayName: 'Run tests'
            continueOnError: true

  # ============================================================================
  # SECURITY SCAN
  # ============================================================================
  - stage: Security
    displayName: 'Security Scan'
    dependsOn: Build
    jobs:
      - job: SnykScan
        displayName: 'Snyk Security Scan'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js'

          - script: npm ci
            displayName: 'Install dependencies'

          - script: |
              npm install -g snyk
              snyk test --severity-threshold=high || true
            displayName: 'Snyk Dependency Scan'
            env:
              SNYK_TOKEN: $(SNYK_TOKEN)
            continueOnError: true

  # ============================================================================
  # DEPLOY (Manual Trigger)
  # ============================================================================
  - stage: Deploy
    displayName: 'Deploy to Azure Container Apps'
    dependsOn: Security
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployJob
        displayName: 'Deploy'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: NodeTool@0
                  inputs:
                    versionSpec: '$(nodeVersion)'
                  displayName: 'Install Node.js'

                # Use AzureCLI task - authenticates via Service Connection (no credentials needed in variables)
                - task: AzureCLI@2
                  displayName: 'Deploy to Azure Container Apps'
                  inputs:
                    azureSubscription: 'azure-service-connection'  # Configure this in Project Settings â†’ Service Connections
                    scriptType: 'bash'
                    scriptLocation: 'scriptPath'
                    scriptPath: 'deploy.sh'
                  env:
                    # Only Key Vault name needed - everything else fetched from Key Vault
                    AZURE_KEYVAULT_NAME: $(AZURE_KEYVAULT_NAME)
